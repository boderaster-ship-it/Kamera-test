<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Kamera Line-Art Filter ‚Äì Auto-Pause am Ende</title>
<style>
  :root { --gap:12px; --bg:#0b0b0b; --panel:#141414; --text:#fff; --muted:#9aa0a6; --radius:14px; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .app{height:100%;display:grid;grid-template-rows:1fr auto;gap:var(--gap);
       padding:env(safe-area-inset-top) var(--gap) calc(env(safe-area-inset-bottom)+var(--gap)) var(--gap)}
  .stage{position:relative;overflow:hidden;border-radius:var(--radius);background:#000;box-shadow:0 0 0 1px #222 inset}
  video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .mirror{transform:scaleX(-1)}
  .hud{position:absolute;left:0;right:0;top:0;display:flex;gap:8px;padding:8px;align-items:center;justify-content:center;pointer-events:none}
  .pill{font:600 12px/1 system-ui;color:#fff;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:999px;backdrop-filter:blur(4px);pointer-events:auto}
  .controls{display:grid;gap:var(--gap);grid-template-columns:1fr 1fr}
  .panel{background:var(--panel);border-radius:var(--radius);padding:var(--gap);display:grid;gap:var(--gap)}
  .row{display:grid;gap:8px}
  label{font-size:13px;color:var(--muted)}
  select,button,input[type="range"]{width:100%;font-size:16px;padding:12px 14px;border-radius:12px;border:1px solid #2a2a2a;background:#111;color:#fff}
  input[type="range"]{padding:10px}
  button.primary{background:#0a84ff;border-color:#0a84ff;font-weight:700}
  button.alt{background:#2a2a2a;border-color:#2a2a2a}
  button.good{background:#34c759;border-color:#34c759;font-weight:700}
  button.warn{background:#ff9f0a;border-color:#ff9f0a;font-weight:700}
  .hint{font-size:12px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="app">
  <div class="stage">
    <video id="raw" playsinline muted autoplay></video>
    <canvas id="out" class="mirror"></canvas>
    <div class="hud">
      <span class="pill" id="hud">Filter: pausiert</span>
    </div>
  </div>

  <div class="controls">
    <div class="panel">
      <div class="row">
        <label for="orientation">Ausrichtung</label>
        <select id="orientation">
          <option value="line-h">Horizontal</option>
          <option value="line-v">Vertikal</option>
        </select>
      </div>
      <div class="row">
        <label for="speed">Geschwindigkeit: <span id="speedVal">50</span> px/s</label>
        <input id="speed" type="range" min="5" max="300" step="1" value="50" />
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr;display:grid;gap:12px">
        <button id="start" class="primary">‚ñ∂Ô∏é Start</button>
        <button id="pause" class="warn" disabled>‚è∏Ô∏é Pause</button>
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr;display:grid;gap:12px">
        <button id="reset" class="alt">‚Ü∫ Reset (neu einfrieren)</button>
        <button id="flip" class="alt">Kamera wechseln</button>
      </div>
    </div>

    <div class="panel">
      <div class="row">
        <button id="save" class="good">üñºÔ∏è Aktuelles Bild speichern (JPEG)</button>
      </div>
      <div class="row">
        <div class="hint">iPhone: Share-Sheet ‚Üí ‚ÄûBild sichern‚Äú (Fotos). Fallback: Download oder Tab.</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const raw = $('#raw');
  const out = $('#out');
  const ctx = out.getContext('2d',{alpha:false});
  const hud = $('#hud');

  const selOrient = $('#orientation');
  const rngSpeed = $('#speed');
  const speedVal = $('#speedVal');
  const btnStart = $('#start');
  const btnPause = $('#pause');
  const btnReset = $('#reset');
  const btnFlip  = $('#flip');
  const btnSave  = $('#save');

  let facingMode='user', stream=null;

  async function initMedia(){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:false});
    raw.srcObject=stream; await raw.play();
    await new Promise(r=>{if(raw.videoWidth)r();else raw.addEventListener('loadedmetadata',r,{once:true})});
    out.width=acc.width=raw.videoWidth; out.height=acc.height=raw.videoHeight;
    resetLineArt();
  }

  /* --- Filter-Logik --- */
  let mode='line-h',running=false,line=0,linePrev=0,lineSpeed=50,animId=0,lastTs=0;
  const acc=document.createElement('canvas'); const accCtx=acc.getContext('2d',{alpha:false});

  function resetLineArt(){
    line=linePrev=0; accCtx.fillStyle='#000'; accCtx.fillRect(0,0,acc.width,acc.height);
    renderFrame(); hud.textContent=running?labelRun():'Filter: pausiert';
  }
  function labelRun(){return `Filter: aktiv ‚Äì ${(mode==='line-h'?'Horizontal':'Vertikal')} @ ${Math.round(lineSpeed)} px/s`;}

  function draw(ts){
    animId=requestAnimationFrame(draw); const dt=Math.min(100,ts-lastTs)/1000; lastTs=ts;
    if(running) step(dt); renderFrame();
  }

  function step(dt){
    const W=out.width,H=out.height; linePrev=line;
    if(mode==='line-h'){
      line+=lineSpeed*dt;
      if(line>=H){autoPause(); line=H;} else {
        const y0=Math.floor(linePrev),y1=Math.floor(line);
        if(y1>y0) accCtx.drawImage(raw,0,y0,W,y1-y0,0,y0,W,y1-y0);
      }
    } else {
      line+=lineSpeed*dt;
      if(line>=W){autoPause(); line=W;} else {
        const x0=Math.floor(linePrev),x1=Math.floor(line);
        if(x1>x0) accCtx.drawImage(raw,x0,0,x1-x0,H,x0,0,x1-x0,H);
      }
    }
  }

  function autoPause(){
    running=false; hud.textContent='Filter: automatisch pausiert (Ende erreicht)';
    btnStart.disabled=false; btnPause.disabled=true;
  }

  function renderFrame(){
    const W=out.width,H=out.height;
    if(mode==='line-h'){
      if(line>0) ctx.drawImage(acc,0,0,W,line,0,0,W,line);
      if(line<H) ctx.drawImage(raw,0,line,W,H-line,0,line,W,H-line);
      ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fillRect(0,Math.floor(line)-1,W,2);
    } else {
      if(line>0) ctx.drawImage(acc,0,0,line,H,0,0,line,H);
      if(line<W) ctx.drawImage(raw,line,0,W-line,H,line,0,W-line,H);
      ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fillRect(Math.floor(line)-1,0,2,H);
    }
  }

  /* --- Bild speichern --- */
  function saveImage(){
    out.toBlob(async b=>{
      if(!b) return; const jpg=new Blob([b],{type:'image/jpeg'}); const f=new File([jpg],'frame.jpg',{type:'image/jpeg'});
      try{if(navigator.canShare&&navigator.canShare({files:[f]})){await navigator.share({files:[f],title:'Frame'});return;}}catch{}
      const url=URL.createObjectURL(jpg); const a=document.createElement('a'); a.href=url; a.download='frame.jpg'; document.body.appendChild(a); a.click();
      setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},1200);
    },'image/jpeg',0.92);
  }

  /* --- UI --- */
  selOrient.onchange=()=>{mode=selOrient.value; resetLineArt();}
  rngSpeed.oninput=()=>{lineSpeed=parseFloat(rngSpeed.value); speedVal.textContent=Math.round(lineSpeed); if(running)hud.textContent=labelRun();}
  btnStart.onclick=()=>{if(!animId){lastTs=performance.now();animId=requestAnimationFrame(draw);} running=true; hud.textContent=labelRun(); btnStart.disabled=true; btnPause.disabled=false;}
  btnPause.onclick=()=>{running=false; hud.textContent='Filter: pausiert'; btnStart.disabled=false; btnPause.disabled=true;}
  btnReset.onclick=resetLineArt;
  btnFlip.onclick=async()=>{facingMode=(facingMode==='user')?'environment':'user'; out.classList.toggle('mirror',facingMode==='user'); await initMedia();}
  btnSave.onclick=saveImage;

  initMedia().then(()=>{if(!animId){lastTs=performance.now();animId=requestAnimationFrame(draw);} running=false;});
})();
</script>
</body>
</html>
